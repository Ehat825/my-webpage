<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Stacked Bar Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <!-- Dropdowns for choosing variables -->
  <div>
    <label for="yVariable">Select Score Variable:</label>
    <select id="yVariable">
      <option value="math_score">Math Score</option>
      <option value="reading_score">Reading Score</option>
      <option value="writing_score">Writing Score</option>
      <option value="total_score">Total Score</option>
      <option value="average_score">Average Score</option>
    </select>

    <label for="xVariable">Select Category:</label>
    <select id="xVariable">
      <option value="race_ethnicity">Race/Ethnicity</option>
      <option value="parental_level_of_education">Parental Education Level</option>
    </select>

    <label for="colorVariable">Color by:</label>
    <select id="colorVariable">
      <option value="">None</option>
      <option value="gender">Gender</option>
      <option value="lunch">Lunch</option>
      <option value="test_preparation_course">Test Preparation</option>
    </select>
  </div>

  <svg width="600" height="400"></svg>

  <script>
    const svg = d3.select("svg");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = {top: 20, right: 20, bottom: 50, left: 60};

    // Load data
    d3.csv("Cleaned_Students_Performance.csv").then(data => {
      // Parse numeric values
      data.forEach(d => {
        d.math_score = +d.math_score;
        d.reading_score = +d.reading_score;
        d.writing_score = +d.writing_score;
        d.total_score = +d.total_score;
        d.average_score = +d.average_score;
      });

      let yVar = "math_score";
      let xVar = "parental_level_of_education";
      let colorVar = "";

      function updateChart() {
        // Group data by selected x-variable and color variable, calculating averages for y-variable
        const groupedData = Array.from(
          d3.rollup(
            data,
            v => {
              const colorGroups = Array.from(
                d3.group(v, d => d[colorVar])
              ).map(([key, values]) => ({
                colorCategory: key,
                yValue: d3.mean(values, d => d[yVar])
              }));
              return colorGroups;
            },
            d => d[xVar]
          ),
          ([key, value]) => ({ xCategory: key, colorGroups: value })
        );

        const xScale = d3.scaleBand()
          .domain(groupedData.map(d => d.xCategory))
          .range([margin.left, width - margin.right])
          .padding(0.1);

        const yScale = d3.scaleLinear()
          .domain([0, d3.max(groupedData, d => d3.sum(d.colorGroups, g => g.yValue))])
          .nice()
          .range([height - margin.bottom, margin.top]);

        svg.selectAll("*").remove();

        svg.append("g")
          .attr("transform", `translate(0,${height - margin.bottom})`)
          .call(d3.axisBottom(xScale))
          .selectAll("text")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        svg.append("g")
          .attr("transform", `translate(${margin.left},0)`)
          .call(d3.axisLeft(yScale));

        const colorScale = colorVar
          ? d3.scaleOrdinal(d3.schemeCategory10).domain([...new Set(data.map(d => d[colorVar]))])
          : null;

        // Stacked bars
        svg.selectAll("g.stacked-bar")
          .data(groupedData)
          .enter()
          .append("g")
          .attr("class", "stacked-bar")
          .attr("transform", d => `translate(${xScale(d.xCategory)},0)`)
          .selectAll("rect")
          .data(d => {
            let cumulative = 0;
            return d.colorGroups.map(g => {
              const start = cumulative;
              cumulative += g.yValue;
              return {
                ...g,
                yStart: start,
                yEnd: cumulative
              };
            });
          })
          .enter()
          .append("rect")
          .attr("x", 0)
          .attr("y", d => yScale(d.yEnd))
          .attr("width", xScale.bandwidth())
          .attr("height", d => yScale(d.yStart) - yScale(d.yEnd))
          .attr("fill", d => colorScale ? colorScale(d.colorCategory) : "steelblue");
      }

      updateChart();

      d3.select("#yVariable").on("change", function() {
        yVar = this.value;
        updateChart();
      });

      d3.select("#xVariable").on("change", function() {
        xVar = this.value;
        updateChart();
      });

      d3.select("#colorVariable").on("change", function() {
        colorVar = this.value;
        updateChart();
      });
    });
  </script>
</body>
</html>
